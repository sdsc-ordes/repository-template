{
  description = "repository-template";

  nixConfig = {
    extra-trusted-substituters = [
      # Nix community's cache server
      "https://nix-community.cachix.org"
      "https://devenv.cachix.org"
    ];
    extra-trusted-public-keys = [
      "nix-community.cachix.org-1:mB9FSh9qf2dCimDSUo8Zy7bkq5CX+/rkCWyvRCYg3Fs="
      "devenv.cachix.org-1:w1cLUi8dv3hnoSPGAuibQv+f9TZLr6cv/Hm9XgU50cw="
    ];
  };

  # We use flake-parts to assemble all flake outputs.
  # This gives nicer modularity. All `.parts` files are
  # `flake-parts` module files.
  outputs =
    inputs:
    let
      lib = inputs.nixpkgs.lib;
    in
    inputs.flake-parts.lib.mkFlake
      {
        inherit inputs;
      }
      (
        lib.pipe inputs.import-tree [
          # NOTE: Uncomment the below to inspect what modules are loaded.
          # (i: i.map (x: lib.info "Importing :${x}" x))
          (i: i.filter (lib.hasInfix ".parts."))
          (i: i ./.)
        ]
      );

  inputs = {
    # Importing flake-parts modules recursively.
    import-tree = {
      url = "github:vic/import-tree";
    };

    systems = {
      # Using `nix-systems` flake specification.
      url = "path:./flake/systems.nix";
      flake = false;
    };

    flake-parts = {
      url = "github:hercules-ci/flake-parts";
    };

    # Nixpkgs (latest ones).
    nixpkgs.url = "github:nixos/nixpkgs/nixos-unstable";

    # Nixpkgs (stable NixOS branch)
    nixpkgs-stable.url = "github:nixos/nixpkgs/nixos-25.05";

    # Format the repo with nix-treefmt.
    treefmt-nix = {
      url = "github:numtide/treefmt-nix";
      inputs.nixpkgs.follows = "nixpkgs";
    };

    # The devenv module to create good development shells.
    devenv = {
      url = "github:cachix/devenv/latest";
      inputs.nixpkgs.follows = "nixpkgs-devenv";
    };
    # We should lock the pkgs in `mkShell` here:
    # https://github.com/cachix/devenv/issues/1797
    # to devenvs rolling nixpkgs. Note: that does not restrict the use of
    # 'nixpkgs' input in devenv modules.
    nixpkgs-devenv.url = "github:cachix/devenv-nixpkgs/rolling";

    # To build a base image with Nix.
    nix = {
      url = "github:nixos/nix";
      inputs.nixpkgs.follows = "nixpkgs";
    };

    {% if project_language == "rust" %}
    # The Rust overlay to include the latest toolchain.
    rust-overlay = {
      url = "github:oxalica/rust-overlay";
      inputs.nixpkgs.follows = "nixpkgs";
    };
    {% elif project_language == "python" -%}
    # The Python packages for all versions.
    nixpkgs-python = {
      url = "github:cachix/nixpkgs-python";
      inputs.nixpkgs.follows = "nixpkgs";
    };
    {%- endif %}
  };
}
